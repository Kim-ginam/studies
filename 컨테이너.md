# Docker

## Dockerfile
- **FROM openjdk:8-jdk-alpine**: OpenJDK 8 Alpine이라는 베이스 이미지를 사용하여 이미지를 생성 (Docker Hub에서 검색 가능)
- **VOLUME /tmp**: 가상의 임시 디렉토리를 생성
- **COPY target/users-ws-0.1.jar users-service.jar**: 호스트의 파일을 컨테이너에 해당 명칭으로 복사 (Dockerfile 위치 기준)
- **ENTRYPOINT**: 컨테이너 실행 시 사용할 명령어 설정
  ```plaintext
  ENTRYPOINT ["java",
  "-Djava.security.egd=file:/dev/./urandom",
  "-jar",
  "users-service.jar"]


- Docker 명령어:
```plaintext 
    $ docker build -t edowon0623/users-service:1.0 . : 이미지 생성
    $ docker push edowon0623/user-service:1.0 : 컨테이너 이미지를 레지스트리에 등록
    $ docker pull edowon0623/user-service:1.0 : 이미지 가져오기
```

# Docker Compose
```
version: '2'
services:
  zookeeper:
    image: wurstmeister/zookeeper
    ports:
      - "2181:2181"
    networks:
      my-network:
        ipv4_address: 172.18.0.100

  kafka:
    image: wurstmeister/kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: 172.18.0.101
      KAFKA_CREATE_TOPICS: "test:1:1"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      my-network:
        ipv4_address: 172.18.0.101

networks:
  my-network:
    name: ecommerce-network
```

# Kubernetes Service Types
- ClusterIP: 클러스터 내부에서만 접근 가능한 서비스
- NodePort: 클러스터 노드의 특정 포트를 통해 외부와 내부 모두 서비스에 액세스 가능
- LoadBalancer: 클라우드 제공업체의 로드밸런서를 통해 외부에서 접근 가능
- Ingress: HTTP/HTTPS 라우팅을 관리하는 리소스로, 외부에서 클러스터 내부로 접근 가능

# Ingress 예시
- AWS ALB
```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
spec:
  ingressClassName: alb
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: membership-service
                port:
                  name: http
```
- NHN Cloud
```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
  annotations:
    ncp.ingress.kubernetes.io/scheme: internet-facing
    ncp.ingress.kubernetes.io/target-type: ip
spec:
  ingressClassName: ncp
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: membership-service
                port:
                  name: http
```

# Kustomize
- 쿠버네티스 리소스 구성 관리 및 배포를 간편화하는 도구
- 기존 베이스 파일을 사용하고 각 환경에 맞게 patch.yaml 파일을 만들어서 구성
```
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - base/deployment.yaml
patchesStrategicMerge:
  - overlay/deployment.yaml
```
- 다양한 리소스 및 설정 방법:
    - namespace: 모든 자원에 네임스페이스 추가
    - namePrefix: 모든 자원에 접두어 추가
    - nameSuffix: 모든 자원에 접미어 추가
    - commonLabels: 리소스와 selector에 레이블 추가

# Helm
- 쿠버네티스를 하나의 패키지로 관리하고 배포하는 도구
- Helm Chart와 values.yaml 파일을 사용하여 설정 가능
- Helm 명령어
```
helm create membership-service-chart: Helm 차트 생성
helm install --namespace dev --create-namespace dev-membership-service . -f values-dev.yaml: 차트 설치
helm upgrade --namespace dev --create-namespace dev-membership-service . -f values-dev.yaml: 수정하여 재배포
helm uninstall dev-membership-service -n dev: 리소스 삭제
```

